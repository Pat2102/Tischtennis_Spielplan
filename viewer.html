<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spielplan v1.2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>TTT</h1>
    <p>Spielplan für das Turbine-Tischtennis-Turnier:</p>

    <h3>Spielplan:</h3>
    <table id="scheduleTable">
        <thead>
            <tr>
                <th>Spiel</th>
                <th>Team 1</th>
                <th>Team 2</th>
                <th>Ergebnis</th>
            </tr>
        </thead>
        <tbody>
            <!-- Der Spielplan wird hier eingefügt -->
        </tbody>
    </table>

    <h3>Zwischenstand:</h3>
    <table id="standingsTable">
        <thead>
            <tr>
                <th>Platz</th>
                <th>Team</th>
                <th>Punkte</th>
                <th>Spiele</th>
                <th>+/-</th>
            </tr>
        </thead>
        <tbody>
            <!-- Der Zwischenstand wird hier eingefügt -->
        </tbody>
    </table>

    <h3>Team-Mitglieder:</h3>
    <table id="teamsTable">
        <thead>
            <tr>
                <th>Team</th>
                <th>Mitglied 1</th>
                <th>Mitglied 2</th>
            </tr>
        </thead>
        <tbody>
            <!-- Die Team-Mitglieder werden hier eingefügt -->
        </tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAksVQRYriHb9gS7TjgeN3faX10IoKJBIw",
            authDomain: "tischtennis-9575d.firebaseapp.com",
            databaseURL: "https://tischtennis-9575d-default-rtdb.firebaseio.com",
            projectId: "tischtennis-9575d",
            storageBucket: "tischtennis-9575d.appspot.com",
            messagingSenderId: "164931288159",
            appId: "1:164931288159:web:5863d07a4cf511ee462fea"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const scheduleTable = document.getElementById('scheduleTable').querySelector('tbody');
        const standingsTable = document.getElementById('standingsTable').querySelector('tbody');
        const teamsTable = document.getElementById('teamsTable').querySelector('tbody');

        const scheduleRef = ref(db, 'spielplan');
        const teamsRef = ref(db, 'teams');

        // Spielplan und Zwischenstand rendern
        onValue(scheduleRef, (snapshot) => {
            const schedule = snapshot.val();
            if (schedule) {
                renderSchedule(schedule);
            } else {
                scheduleTable.innerHTML = `<tr><td colspan="4">Kein Spielplan verfügbar</td></tr>`;
                standingsTable.innerHTML = `<tr><td colspan="5">Keine Ergebnisse verfügbar</td></tr>`;
            }
        });

        // Team-Mitglieder rendern
        onValue(teamsRef, (snapshot) => {
            const teams = snapshot.val();
            if (teams) {
                renderTeams(teams);
            } else {
                teamsTable.innerHTML = `<tr><td colspan="3">Keine Teams verfügbar</td></tr>`;
            }
        });

      function renderSchedule(schedule) {
    scheduleTable.innerHTML = '';
    standingsTable.innerHTML = '';

    const standings = {};

    schedule.forEach(game => {
        // Punkte und Punktverhältnis aus den results berechnen
        let pointsTeam1 = 0;
        let pointsTeam2 = 0;

        game.results.forEach(set => {
            const [score1, score2] = set.split('-').map(Number);

            // Falls die Scores ungültig sind, auf 0 setzen
            if (isNaN(score1)) score1 = 0;
            if (isNaN(score2)) score2 = 0;

            pointsTeam1 += score1;
            pointsTeam2 += score2;
        });

        // Eintrag in der Spielplan-Tabelle
        const row = `<tr>
            <td>Spiel ${game.match}</td>
            <td>${game.team1}</td>
            <td>${game.team2}</td>
            <td>${game.finalResult} (${game.results.join(', ')})</td>
        </tr>`;
        scheduleTable.innerHTML += row;

        // Initialisiere die Teams in der Standings-Tabelle
        if (!standings[game.team1]) standings[game.team1] = { wins: 0, losses: 0, scored: 0, conceded: 0, goalDiff: 0 };
        if (!standings[game.team2]) standings[game.team2] = { wins: 0, losses: 0, scored: 0, conceded: 0, goalDiff: 0 };

        // Punktestand und Spielausgang aktualisieren
        standings[game.team1].scored += pointsTeam1;
        standings[game.team1].conceded += pointsTeam2;
        standings[game.team2].scored += pointsTeam2;
        standings[game.team2].conceded += pointsTeam1;

        standings[game.team1].goalDiff += pointsTeam1 - pointsTeam2;
        standings[game.team2].goalDiff += pointsTeam2 - pointsTeam1;

        if (game.finalResult.includes(game.team1)) {
            standings[game.team1].wins += 2;
            standings[game.team2].losses += 2;
        } else if (game.finalResult.includes(game.team2)) {
            standings[game.team1].losses += 2;
            standings[game.team2].wins += 2;
        }
    });

    // Sortiere die Tabelle nach Punkten und Punktverhältnis
    const sortedStandings = Object.entries(standings)
        .map(([team, data]) => ({ team, ...data }))
        .sort((a, b) => b.wins - a.wins || b.goalDiff - a.goalDiff);

    // Standings-Tabelle rendern
    sortedStandings.forEach((entry, index) => {
        const row = `<tr>
            <td>${index + 1}</td>
            <td>${entry.team}</td>
            <td>${entry.wins}:${entry.losses}</td>
            <td>${entry.scored}:${entry.conceded}</td>
            <td>${entry.goalDiff}</td>
        </tr>`;
        standingsTable.innerHTML += row;
    });
}



        function renderTeams(teams) {
            teamsTable.innerHTML = '';
            teams.forEach(team => {
                const row = `<tr>
                    <td>${team.teamName}</td>
                    <td>${team.player1}</td>
                    <td>${team.player2}</td>
                </tr>`;
                teamsTable.innerHTML += row;
            });
        }
    </script>
</body>
</html>
